# 颯式
颯式（はやてしき）は、「クイックソート種より高速」を目指した、マージソートの改良アルゴリズムです。  

以下の特徴があります。  
* 比較ソート
* 安定ソート
* 外部領域：N
* 最良時間：O(N)
* 平均時間：O(N log N)
* 最悪時間：O(N log N)
* 再帰：無し

<br>

# 基本となるアルゴリズム
* 外部領域を、2Nの連続帯として見立てます。
* 値を外部領域に置く際、以下のルールを適用します。
  * （最大値 ≦ 値）であれば、昇順列の上側に置き、最大値を更新します。
  * （値 ＜ 最小値）であれば、降順列の下側に置き、最小値を更新します。
  * （最小値 ≦ 値 ＜ 最大値）であれば、新しい値（最大値であり最小値）を昇順列に置き、それまでに並べた値群をPartとします。
* Part群をマージします。

## 具体的な流れ
~~~
外部領域を、2Nの連続帯として見立てます

4 5 1 2 7 6 3 8|入力列
. . . . . . . .|外部領域
→昇順列  降順列←|実際

               |4 5 1 2 7 6 3 8|入力列
. . . . . . . . . . . . . . . .|外部領域
        降順列←｜→昇順列        |2N見立て
~~~
~~~
新しい値（最大値であり最小値）を昇順列に置く
               |. 5 1 2 7 6 3 8
. . . . . . . . 4 . . . . . . .
~~~
~~~
次の値は（最大値 ≦ 値）なので、昇順列の上側に置き、最大値を更新
               |. . 1 2 7 6 3 8
. . . . . . . . 4 5 . . . . . .
~~~
~~~
次の値は（値 ＜ 最小値）なので、降順列の下側に置き、最小値を更新
               |. . . 2 7 6 3 8
. . . . . . . 1 4 5 . . . . . .
~~~
~~~
次の値は（最小値 ≦ 値 ＜ 最大値）なので、新しい値（最大値であり最小値）を昇順列に置く（Part：145が完成）
               |. . . . 7 6 3 8
. . . . . . .|1 4 5|2 . . . . .
~~~
~~~
次の値は（最大値 ≦ 値）なので、昇順列の上側に置き、最大値を更新
               |. . . . . 6 3 8
. . . . . . .|1 4 5|2 7 . . . .
~~~
~~~
次の値は（最小値 ≦ 値 ＜ 最大値）なので、新しい値（最大値であり最小値）を昇順列に置く（Part：27が完成）
               |. . . . . . 3 8
. . . . . . .|1 4 5|2 7|6 . . .
~~~
~~~
次の値は（値 ＜ 最小値）なので、降順列の下側に置き、最小値を更新
               |. . . . . . . 8
. . . . . . 3|1 4 5|2 7|6 . . .
~~~
~~~
次の値は（最大値 ≦ 値）なので、昇順列の上側に置く（Part：368が完成）
               |. . . . . . . .
. . . . . .|3|1 4 5|2 7|6 8|. .
~~~
~~~
最終的な外部領域
4 5|2 7|6 8|. .  昇順列見立て
. . . . . .|3|1  降順列見立て
4 5|2 7|6 8|3|1  実際の内容
~~~
~~~
生成したPart群をマージします  
145  27  368  
12457  368  
12345678  
ソート完了  
~~~

<br>

# 改良
基本アルゴリズムから更に、以下の改良を施します。
* Partの長さを確保する為、インサートソートを行います。
* 再帰をしないように、逐次マージを行います。

<br>

# ビルド＆テスト
検証を行った環境は以下のとおりです。
* Windows 10 Pro 64bit
* Core i7-8700 3.20GHz

## **Msvc**
Microsoft(R) C/C++ Optimizing Compiler Version 19.16.27027.1 for x64  
~~~
cl Main.cpp -std:c++14 -DNDEBUG -Ox -EHsc -Fe:TestMsvc.exe
TestMsvc.exe
~~~

## **clang++**
clang version 8.0.0 (tags/RELEASE_800/final)  
Target: x86_64-w64-windows-gnu  
~~~
clang++ Main.cpp -std=c++14 -DNDEBUG -O3 -o TestClang++.exe
TestClang++.exe
~~~

## **g++**
gcc version 8.3.0 (Rev2, Built by MSYS2 project)  
Target: x86_64-w64-mingw32  
~~~
g++ Main.cpp -std=c++14 -DNDEBUG -O3 -o TestG++.exe
TestG++.exe
~~~

<br>

# 乱数ベンチマーク
同じシードから生成したfloat値をソートしました。  
単位は秒で、数値が低いほど高速です。  

## **Msvc**
|件数|std::sort|std::stable_sort|gfx::timsort|颯式|
|-:|-:|-:|-:|-:|
|10,000|0.00045542|0.00038963|0.00063259|**0.00038294**|
|1,000,000|0.06900306|0.06157810|0.08987316|**0.05963387**|
|100,000,000|8.95517375|8.46306964|11.66389608|**7.92667359**|

他のコンパイラと比較しても、std::sortが遅く、std::stable_sortが速い結果となったMsvc。  
初っ端から意外な結果が出ましたが、この特性のお陰で勝つことができました。  

## **clang++**
|件数|std::sort|std::stable_sort|gfx::timsort|颯式|
|-:|-:|-:|-:|-:|
|10,000|**0.00039482**|0.00044310|0.00058579|0.00040413|
|1,000,000|**0.05872628**|0.06865944|0.08372736|0.06585446|
|100,000,000|**7.77238754**|9.34188338|11.05923570|8.91061443|

残念な結果となったclang++。  
他のコンパイラと比較して、最適化ロジックに疑問が残る結果となりました。  

## **g++**
|件数|std::sort|std::stable_sort|gfx::timsort|颯式|
|-:|-:|-:|-:|-:|
|10,000|0.00039890|0.00043748|0.00063354|**0.00037713**|
|1,000,000|**0.05793422**|0.06557857|0.08855738|0.05840274|
|100,000,000|**7.61435214**|8.86337450|11.39435302|7.83662079|

善戦したのがg++。  
「1,000,000」でも僅差となりました。  
「100,000,000」で差が開いたのは、インプレースかアウトプレースかによる、キャッシュ効率の影響と思われます。  

<br>

# 特性ベンチマーク
以下は全て、float値「100,000,000」件でソートしました。  
単位は秒で、数値が低いほど高速です。  

## 同値
||std::sort|std::stable_sort|gfx::timsort|颯式|
|-:|-:|-:|-:|-:|
|Msvc|0.06713918|1.24926460|**0.03552456**|0.04001278|
|clang++|0.96321854|1.38927788|0.04675406|**0.03971196**|
|g++|1.24455174|1.27419866|0.04730418|**0.03958826**|

## 昇順済み 
||std::sort|std::stable_sort|gfx::timsort|颯式|
|-:|-:|-:|-:|-:|
|Msvc|1.04917134|1.24956610|**0.03797098**|0.04027310|
|clang++|1.06030176|1.38933688|0.04619012|**0.03979394**|
|g++|1.42411580|1.26989158|0.04694066|**0.03960894**|

## 降順済み
||std::sort|std::stable_sort|gfx::timsort|颯式|
|-:|-:|-:|-:|-:|
|Msvc|1.24351168|1.62816732|**0.05992322**|0.06486218|
|clang++|0.76173164|1.49226176|**0.07894234**|0.08284760|
|g++|1.04372210|1.50443338|**0.07921356**|0.08537936|

<br>

# 余談
如何だったでしょうか？  

std::stable_sortに全勝しました！  
gfx::timsortには、乱数では勝てましたが、特性では僅差となりました。  
そして、std::sortに常勝するのは容易でないことが分かりました。  
ですが、環境や運用次第では、std::sortに勝る可能性を秘めているかもしれません。  

マージソート種がクイックソート種に勝てる日は来るのでしょうか？  

ソートアルゴリズムには、まだ浪漫が残っています。  

---
以下も併せて読んでいただけると、より楽しめるかも知れません。  
* [刹那式（せつなしき）](https://github.com/EmuraDaisuke/SortingAlgorithm.SetsunaShiki)
* [焔式（ほむらしき）](https://github.com/EmuraDaisuke/SortingAlgorithm.HomuraShiki)
